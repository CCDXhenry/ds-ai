{
  "version": 1,
  "timestamp": 1740020259.5392709,
  "files": {
    "C:\\project\\python_project\\Va\\ai\\demo1\\v1\\main.py": {
      "content": "\"\"\"\nOpenAI\u7384\u5e7b\u5c0f\u8bf4\u5192\u9669\u751f\u6210\u5668 - \u589e\u5f3a\u7248\n\u65b0\u589e\u529f\u80fd\uff1a\n1. \u7528\u6237\u914d\u7f6e\u7cfb\u7edf\n2. \u591a\u7ed3\u5c40\u7cfb\u7edf\n3. \u81ea\u52a8\u5b58\u6863\u529f\u80fd\n4. \u8f93\u5165\u9a8c\u8bc1\u589e\u5f3a\n5. \u8f93\u51fa\u683c\u5f0f\u5316\u589e\u5f3a\n\u4f9d\u8d56\uff1apip install openai python-dotenv termcolor\n\"\"\"\n\nimport os\nimport sys\nimport time\nimport json\nfrom typing import List, Dict, Optional\nfrom pathlib import Path\nfrom termcolor import colored\nimport openai\nfrom dotenv import load_dotenv\n\n# \u52a0\u8f7d\u73af\u5883\u53d8\u91cf\nload_dotenv()\nopenai.api_key = os.getenv(\"OPENAI_API_KEY\")\n\nclass UserConfig:\n    \"\"\"\u7528\u6237\u914d\u7f6e\u7ba1\u7406\u7cfb\u7edf\"\"\"\n    \n    def __init__(self):\n        self.config = {\n            'model': \"gpt-3.5-turbo\",\n            'temperature': 0.8,\n            'max_tokens': 1500,\n            'auto_save': True,\n            'max_history': 5\n        }\n        \n    def update_config(self, key: str, value: str):\n        \"\"\"\u66f4\u65b0\u914d\u7f6e\u53c2\u6570\"\"\"\n        if key in self.config:\n            # \u7c7b\u578b\u8f6c\u6362\u5904\u7406\n            original_type = type(self.config[key])\n            try:\n                self.config[key] = original_type(value)\n            except ValueError:\n                print(f\"\u9519\u8bef\uff1a{value} \u4e0d\u80fd\u8f6c\u6362\u4e3a{original_type}\u7c7b\u578b\")\n                \nclass StoryManager:\n    \"\"\"\u7ba1\u7406\u6545\u4e8b\u751f\u6210\u72b6\u6001\u548c\u4e0a\u4e0b\u6587\"\"\"\n    \n    def __init__(self, config: UserConfig):\n        self.story_history: List[Dict] = []\n        self.current_chapter = 1\n        self.max_retries = 3\n        self.config = config\n        self.decision_points = []  # \u8bb0\u5f55\u5173\u952e\u51b3\u7b56\u70b9\n        self.base_prompt = \"\"\"\n            \u4f60\u662f\u4e00\u4e2a\u7384\u5e7b\u5c0f\u8bf4\u5927\u5e08\uff0c\u8bf7\u751f\u6210\u5305\u542b\u4ee5\u4e0b\u8981\u7d20\u7684\u5192\u9669\u6545\u4e8b\uff1a\n            1. \u4e3b\u89d2\u62e5\u6709\u7279\u6b8a\u4f53\u8d28\u6216\u91d1\u624b\u6307\n            2. \u5305\u542b\u81f3\u5c11\u4e09\u4e2a\u521b\u65b0\u4fee\u70bc\u4f53\u7cfb\n            3. \u6bcf\u7ae0\u5fc5\u987b\u6709\u6218\u6597\u60c5\u8282\u548c\u5b9d\u7269\u83b7\u5f97\n            4. \u5305\u542b\u610f\u60f3\u4e0d\u5230\u7684\u5267\u60c5\u8f6c\u6298\n            5. \u5bf9\u573a\u666f\u548c\u529f\u6cd5\u8fdb\u884c\u8be6\u7ec6\u63cf\u5199\n            \u8bf7\u7528\u4e2d\u6587\u4ee5150\u5b57\u5de6\u53f3\u7684\u6bb5\u843d\u5448\u73b0\uff0c\u7ed3\u5c3e\u7ed9\u51fa2-3\u4e2a\u9009\u62e9\u5206\u652f\n        \"\"\"\n        self.achievements = set()  # \u6210\u5c31\u7cfb\u7edf\n        \n    def generate_story_prompt(self, user_input: str = None) -> List[Dict]:\n        \"\"\"\u6784\u9020\u5e26\u4e0a\u4e0b\u6587\u7684\u63d0\u793a\u8bcd\"\"\"\n        system_msg = {\n            \"role\": \"system\",\n            \"content\": f\"{self.base_prompt} \u5f53\u524d\u662f\u7b2c{self.current_chapter}\u7ae0\uff0c\u4fdd\u6301\u6545\u4e8b\u8fde\u8d2f\u6027\u3002\"\n        }\n        \n        messages = [system_msg]\n        \n        # \u6dfb\u52a0\u4e0a\u4e0b\u6587\u5386\u53f2\uff08\u6839\u636e\u914d\u7f6e\u957f\u5ea6\uff09\n        if self.story_history:\n            messages += self.story_history[-self.config.config['max_history']*2:]\n        \n        # \u6dfb\u52a0\u7528\u6237\u8f93\u5165\n        if user_input:\n            messages.append({\"role\": \"user\", \"content\": user_input})\n        else:\n            messages.append({\"role\": \"user\", \"content\": \"\u8bf7\u5f00\u59cb\u65b0\u7684\u6545\u4e8b\"})\n            \n        return messages\n    \n    def save_progress(self, filename: str = \"autosave.json\"):\n        \"\"\"\u4fdd\u5b58\u5f53\u524d\u8fdb\u5ea6\u5230\u6587\u4ef6\"\"\"\n        save_data = {\n            \"chapter\": self.current_chapter,\n            \"history\": self.story_history,\n            \"decisions\": self.decision_points,\n            \"achievements\": list(self.achievements)\n        }\n        \n        try:\n            with open(filename, 'w', encoding='utf-8') as f:\n                json.dump(save_data, f, ensure_ascii=False)\n            print(colored(f\"\\n\u8fdb\u5ea6\u5df2\u81ea\u52a8\u4fdd\u5b58\u5230 {filename}\", 'green'))\n        except Exception as e:\n            print(colored(f\"\\n\u4fdd\u5b58\u5931\u8d25: {e}\", 'red'))\n            \n    def load_progress(self, filename: str) -> bool:\n        \"\"\"\u4ece\u6587\u4ef6\u52a0\u8f7d\u8fdb\u5ea6\"\"\"\n        try:\n            with open(filename, 'r', encoding='utf-8') as f:\n                data = json.load(f)\n            self.current_chapter = data['chapter']\n            self.story_history = data['history']\n            self.decision_points = data['decisions']\n            self.achievements = set(data['achievements'])\n            return True\n        except Exception as e:\n            print(colored(f\"\\n\u52a0\u8f7d\u5931\u8d25: {e}\", 'red'))\n            return False\n\nclass OpenAIClient:\n    \"\"\"\u5904\u7406OpenAI API\u4ea4\u4e92\"\"\"\n    \n    def __init__(self, config: UserConfig):\n        self.config = config\n        \n    def generate_story(self, messages: List[Dict]) -> Optional[str]:\n        \"\"\"\u8c03\u7528OpenAI\u751f\u6210\u6545\u4e8b\u5185\u5bb9\"\"\"\n        for retry in range(3):\n            try:\n                response = openai.ChatCompletion.create(\n                    model=self.config.config['model'],\n                    messages=messages,\n                    temperature=self.config.config['temperature'],\n                    max_tokens=self.config.config['max_tokens']\n                )\n                return response.choices[0].message['content'].strip()\n            except openai.error.RateLimitError:\n                wait_time = (retry + 1) * 5\n                print(colored(f\"\u901f\u7387\u9650\u5236\u5df2\u8fbe\uff0c{wait_time}\u79d2\u540e\u91cd\u8bd5...\", 'yellow'))\n                time.sleep(wait_time)\n            except Exception as e:\n                print(colored(f\"API\u9519\u8bef: {e}\", 'red'))\n            return None\n\nclass StoryFormatter:\n    \"\"\"\u5904\u7406\u6545\u4e8b\u5185\u5bb9\u7684\u683c\u5f0f\u5316\u548c\u663e\u793a\"\"\"\n    \n    @staticmethod\n    def display_story(content: str, chapter: int):\n        \"\"\"\u7f8e\u5316\u6545\u4e8b\u663e\u793a\"\"\"\n        print(\"\\n\" + colored(\"=\"*50, 'cyan'))\n        print(colored(f\"\ud83d\udcd6 \u7b2c{chapter}\u7ae0 \ud83d\udcd6\", 'yellow', attrs=['bold']))\n        print(colored(\"-\"*50, 'cyan'))\n        # \u5904\u7406\u6bb5\u843d\u683c\u5f0f\n        formatted = content.replace(\". \", \".\\n\").replace(\"\uff01\", \"\uff01\\n\")\n        paragraphs = [p.strip() for p in formatted.split(\"\\n\") if p.strip()]\n        for idx, para in enumerate(paragraphs):\n            if idx == len(paragraphs)-1:\n                print(colored(para, 'magenta'))  # \u6700\u540e\u4e00\u6bb5\u662f\u9009\u9879\n            else:\n                print(colored(para, 'white'))\n        print(colored(\"=\"*50 +",
      "hash": "191cdd16733143afa34e7bccd220079d"
    }
  },
  "history": [],
  "user_feedback": [
    "\u521b\u5efa\u4e00\u4e2a\u8c03\u7528openai\u63a5\u53e3\u7684\u7384\u5e7b\u5c0f\u8bf4\u5386\u9669\u8bb0\uff0c\u901a\u8fc7\u5bf9\u8bdd\u7684\u5f62\u5f0f\uff0c\u6765\u63a8\u52a8\u6545\u4e8b\u7684\u524d\u8fdb\uff0c\u6545\u4e8b\u8981\u6709\u723d\u70b9\u6709\u521b\u65b0",
    "\u57fa\u4e8e\u4ee5\u4e0b\u73b0\u6709\u4ee3\u7801\u8fdb\u884c\u6539\u8fdb\uff1a\n\n\"\"\"\nOpenAI\u7384\u5e7b\u5c0f\u8bf4\u5192\u9669\u751f\u6210\u5668\n\u4f9d\u8d56\uff1apip install openai python-dotenv\n\"\"\"\n\nimport os\nimport sys\nimport time\nfrom typing import List, Dict\nimport openai\nfrom dotenv import load_dotenv\n\n# \u52a0\u8f7d\u73af\u5883\u53d8\u91cf\nload_dotenv()\nopenai.api_key = os.getenv(\"OPENAI_API_KEY\")\n\nclass StoryManager:\n    \"\"\"\u7ba1\u7406\u6545\u4e8b\u751f\u6210\u72b6\u6001\u548c\u4e0a\u4e0b\u6587\"\"\"\n    \n    def __init__(self):\n        self.story_history: List[Dict] = []\n        self.current_chapter = 1\n        self.max_retries = 3\n        self.base_prompt = \"\"\"\n            \u4f60\u662f\u4e00\u4e2a\u7384\u5e7b\u5c0f\u8bf4\u5927\u5e08\uff0c\u8bf7\u751f\u6210\u5305\u542b\u4ee5\u4e0b\u8981\u7d20\u7684\u5192\u9669\u6545\u4e8b\uff1a\n            1. \u4e3b\u89d2\u62e5\u6709\u7279\u6b8a\u4f53\u8d28\u6216\u91d1\u624b\u6307\n            2. \u5305\u542b\u81f3\u5c11\u4e09\u4e2a\u521b\u65b0\u4fee\u70bc\u4f53\u7cfb\n            3. \u6bcf\u7ae0\u5fc5\u987b\u6709\u6218\u6597\u60c5\u8282\u548c\u5b9d\u7269\u83b7\u5f97\n            4. \u5305\u542b\u610f\u60f3\u4e0d\u5230\u7684\u5267\u60c5\u8f6c\u6298\n            5. \u5bf9\u573a\u666f\u548c\u529f\u6cd5\u8fdb\u884c\u8be6\u7ec6\u63cf\u5199\n            \u8bf7\u7528\u4e2d\u6587\u4ee5150\u5b57\u5de6\u53f3\u7684\u6bb5\u843d\u5448\u73b0\uff0c\u7ed3\u5c3e\u7ed9\u51fa2-3\u4e2a\u9009\u62e9\u5206\u652f\n        \"\"\"\n        \n    def generate_story_prompt(self, user_input: str = None) -> List[Dict]:\n        \"\"\"\u6784\u9020\u5e26\u4e0a\u4e0b\u6587\u7684\u63d0\u793a\u8bcd\"\"\"\n        system_msg = {\n            \"role\": \"system\",\n            \"content\": f\"{self.base_prompt} \u5f53\u524d\u662f\u7b2c{self.current_chapter}\u7ae0\uff0c\u4fdd\u6301\u6545\u4e8b\u8fde\u8d2f\u6027\u3002\"\n        }\n        \n        messages = [system_msg]\n        \n        # \u6dfb\u52a0\u4e0a\u4e0b\u6587\u5386\u53f2\n        if self.story_history:\n            messages += self.story_history[-4:]  # \u4fdd\u6301\u6700\u8fd13\u8f6e\u5bf9\u8bdd\n        \n        # \u6dfb\u52a0\u7528\u6237\u8f93\u5165\n        if user_input:\n            messages.append({\"role\": \"user\", \"content\": user_input})\n        else:\n            messages.append({\"role\": \"user\", \"content\": \"\u8bf7\u5f00\u59cb\u65b0\u7684\u6545\u4e8b\"})\n            \n        return messages\n\nclass OpenAIClient:\n    \"\"\"\u5904\u7406OpenAI API\u4ea4\u4e92\"\"\"\n    \n    def __init__(self):\n        self.model = \"gpt-3.5-turbo\"\n        self.temperature = 0.8\n        self.max_tokens = 1500\n        \n    def generate_story(self, messages: List[Dict]) -> str:\n        \"\"\"\u8c03\u7528OpenAI\u751f\u6210\u6545\u4e8b\u5185\u5bb9\"\"\"\n        for _ in range(3):  # \u91cd\u8bd5\u673a\u5236\n            try:\n                response = openai.ChatCompletion.create(\n                    model=self.model,\n                    messages=messages,\n                    temperature=self.temperature,\n                    max_tokens=self.max_tokens\n                )\n                return response.choices[0].message['content'].strip()\n            except Exception as e:\n                print(f\"API\u9519\u8bef: {e}, \u91cd\u8bd5\u4e2d...\")\n                time.sleep(2)\n        return \"\u6545\u4e8b\u751f\u6210\u5931\u8d25\uff0c\u8bf7\u7a0d\u540e\u518d\u8bd5\"\n\ndef display_story(content: str):\n    \"\"\"\u7f8e\u5316\u6545\u4e8b\u663e\u793a\"\"\"\n    print(\"\\n\" + \"=\"*50)\n    print(f\"\ud83d\udcd6 \u7b2c{story_mgr.current_chapter}\u7ae0 \ud83d\udcd6\")\n    print(\"-\"*50)\n    print(content.replace(\". \", \".\\n\"))\n    print(\"=\"*50 + \"\\n\")\n\ndef main():\n    \"\"\"\u4e3b\u7a0b\u5e8f\u5165\u53e3\"\"\"\n    story_mgr = StoryManager()\n    ai_client = OpenAIClient()\n    \n    print(\"\u6b22\u8fce\u6765\u5230\u7384\u5e7b\u5c0f\u8bf4\u5192\u9669\u751f\u6210\u5668\uff01\")\n    print(\"\u8f93\u5165\u4f60\u7684\u9009\u62e9\uff08\u6570\u5b57\uff09\u6216\u81ea\u7531\u8f93\u5165\uff0c\u8f93\u5165q\u9000\u51fa\\n\")\n    \n    user_input = None\n    while True:\n        # \u751f\u6210\u6545\u4e8b\u5185\u5bb9\n        messages = story_mgr.generate_story_prompt(user_input)\n        story_content = ai_client.generate_story(messages)\n        \n        # \u5904\u7406\u751f\u6210\u5931\u8d25\u7684\u60c5\u51b5\n        if \"\u5931\u8d25\" in story_content:\n            print(story_content)\n            break\n            \n        display_story(story_content)\n        \n        # \u8bb0\u5f55\u5386\u53f2\n        story_mgr.story_history.extend([\n            {\"role\": \"assistant\", \"content\": story_content},\n            {\"role\": \"user\", \"content\": user_input} if user_input else None\n        ])\n        \n        # \u83b7\u53d6\u7528\u6237\u8f93\u5165\n        choice = input(\"\u8bf7\u8f93\u5165\u4f60\u7684\u9009\u62e9\uff08\u8f93\u5165\u6570\u5b57\u6216\u81ea\u5b9a\u4e49\u5185\u5bb9\uff09\uff1a\").strip()\n        if choice.lower() == 'q':\n            print(\"\\n\u5192\u9669\u7ed3\u675f\uff0c\u671f\u5f85\u4e0b\u6b21\u518d\u89c1\uff01\")\n            break\n            \n        user_input = f\"\u7528\u6237\u9009\u62e9\uff1a{choice}\u3002\u8bf7\u6839\u636e\u8fd9\u4e2a\u9009\u62e9\u7ee7\u7eed\u53d1\u5c55\u6545\u4e8b\uff0c\u4fdd\u6301\u8282\u594f\u7d27\u51d1\uff0c\u5e76\u6dfb\u52a0\u65b0\u7684\u51b2\u7a81\u548c\u5947\u9047\u3002\"\n        story_mgr.current_chapter += 1\n        \nif __name__ == \"__main__\":\n    try:\n        main()\n    except KeyboardInterrupt:\n        print(\"\\n\u64cd\u4f5c\u5df2\u4e2d\u65ad\")\n        sys.exit(0)\n\n\u6539\u8fdb\u76ee\u6807\uff1a\u6269\u5c55\u73b0\u6709\u529f\u80fd\uff0c\u6dfb\u52a0\u65b0\u7279\u6027\n\n\u8bf7\u4fdd\u6301\u4ee3\u7801\u7684\u6838\u5fc3\u529f\u80fd\uff0c\u5728\u6b64\u57fa\u7840\u4e0a\u8fdb\u884c\u6539\u8fdb\u3002\n"
  ]
}