{
  "version": 3,
  "timestamp": 1740020796.6793313,
  "files": {
    "C:\\project\\python_project\\Va\\ai\\demo1\\v3\\main.py": {
      "content": "\"\"\"\nOpenAI\u7384\u5e7b\u5c0f\u8bf4\u5192\u9669\u751f\u6210\u5668 - \u4e13\u4e1a\u7248 v2.0\n\u6539\u8fdb\u5185\u5bb9\uff1a\n1. \u5b8c\u6574\u6e38\u620f\u5faa\u73af\u5b9e\u73b0\n2. \u589e\u5f3a\u578b\u6210\u5c31\u7cfb\u7edf\n3. \u5b89\u5168\u6587\u4ef6\u4fdd\u5b58\n4. \u591a\u8bed\u8a00\u652f\u6301\n5. \u70ed\u91cd\u8f7d\u914d\u7f6e\n\u4f9d\u8d56\uff1apip install openai python-dotenv termcolor filelock\n\"\"\"\n\nimport os\nimport sys\nimport time\nimport json\nimport re\nimport signal\nfrom pathlib import Path\nfrom typing import List, Dict, Optional, Tuple, Set, Callable\nfrom termcolor import colored\nimport openai\nfrom dotenv import load_dotenv\nfrom functools import lru_cache, wraps\nfrom filelock import FileLock, Timeout\n\n# ...\uff08\u4fdd\u7559\u539f\u6709import\u548c\u914d\u7f6e\u7c7b\uff0c\u65b0\u589e\u4ee5\u4e0b\u6539\u8fdb\uff09...\n\nclass UserConfig:\n    # \u65b0\u589e\u70ed\u91cd\u8f7d\u529f\u80fd\n    def reload_config(self):\n        self.config = self.load_or_init_config()\n        \nclass StoryManager:\n    def __init__(self, config: UserConfig):\n        # \u65b0\u589e\u6210\u5c31\u8fdb\u5ea6\u8ffd\u8e2a\n        self.achievement_progress = {\n            'treasure_hunter': {'current': 0, 'target': 5}\n        }\n        \n    def check_achievements(self):\n        \"\"\"\u68c0\u67e5\u5e76\u89e3\u9501\u6210\u5c31\"\"\"\n        new_achievements = []\n        # \u5b9d\u85cf\u730e\u4eba\u6210\u5c31\u68c0\u67e5\n        if self.achievement_progress['treasure_hunter']['current'] >= 5:\n            if not self.achievements['treasure_hunter'][1]:\n                self.achievements['treasure_hunter'] = (self.achievements['treasure_hunter'][0], True)\n                new_achievements.append('treasure_hunter')\n        return new_achievements\n\n    def record_treasure(self):\n        \"\"\"\u8bb0\u5f55\u83b7\u53d6\u5b9d\u7269\"\"\"\n        self.achievement_progress['treasure_hunter']['current'] += 1\n\nclass StoryFormatter:\n    # \u589e\u5f3a\u591a\u8bed\u8a00\u652f\u6301\n    @classmethod\n    def display_achievement(cls, achievement: str, language: str):\n        ACHIEVEMENT_TEXTS = {\n            'treasure_hunter': {\n                'zh-CN': '\ud83c\udfc6 \u6210\u5c31\u89e3\u9501\uff1a\u5b9d\u85cf\u730e\u4eba\uff08\u6536\u96c65\u4ef6\u5b9d\u7269\uff09',\n                'en-US': '\ud83c\udfc6 Achievement Unlocked: Treasure Hunter'\n            }\n        }\n        print(colored(ACHIEVEMENT_TEXTS[achievement][language], 'magenta'))\n\nclass GameEngine:\n    \"\"\"\u65b0\u589e\u6e38\u620f\u5f15\u64ce\u7c7b\"\"\"\n    def __init__(self, config: UserConfig):\n        self.config = config\n        self.story_manager = StoryManager(config)\n        self.openai_client = OpenAIClient(config)\n        self.is_running = True\n        \n    def handle_interrupt(self, signum, frame):\n        \"\"\"\u5904\u7406\u4e2d\u65ad\u4fe1\u53f7\"\"\"\n        print(colored(\"\\n\u68c0\u6d4b\u5230\u4e2d\u65ad\u4fe1\u53f7\uff0c\u6b63\u5728\u4fdd\u5b58\u8fdb\u5ea6...\", 'yellow'))\n        self.story_manager.save_progress()\n        self.is_running = False\n        \n    def main_loop(self):\n        \"\"\"\u4e3b\u6e38\u620f\u5faa\u73af\"\"\"\n        signal.signal(signal.SIGINT, self.handle_interrupt)\n        \n        while self.is_running:\n            # \u751f\u6210\u6545\u4e8b\u5185\u5bb9\n            messages = self.story_manager.generate_story_prompt()\n            try:\n                content = self.openai_client.generate_story(messages)\n                options = StoryFormatter.display_story(\n                    content, \n                    self.story_manager.current_chapter,\n                    self.config\n                )\n                \n                # \u68c0\u67e5\u6210\u5c31\n                new_achs = self.story_manager.check_achievements()\n                for ach in new_achs:\n                    StoryFormatter.display_achievement(ach, self.config.config['language'])\n                \n                # \u5904\u7406\u7528\u6237\u8f93\u5165\n                choice = self.get_user_choice(options)\n                if choice == 0:  # \u9000\u51fa\n                    self.story_manager.save_progress()\n                    self.is_running = False\n                elif choice == -1:  # \u65e0\u6548\u8f93\u5165\n                    print(colored(\"\u65e0\u6548\u8f93\u5165\uff0c\u8bf7\u91cd\u65b0\u9009\u62e9\", 'red'))\n                else:\n                    self.story_manager.current_chapter += 1\n                    \n            except StoryGenerationError as e:\n                print(colored(f\"\u6545\u4e8b\u751f\u6210\u5931\u8d25: {e}\", 'red'))\n                self.is_running = False\n                \n    def get_user_choice(self, options: List[str]) -> int:\n        \"\"\"\u83b7\u53d6\u7528\u6237\u9009\u62e9\u5e76\u9a8c\u8bc1\"\"\"\n        try:\n            input_str = InputValidator.get_input_with_timeout(\n                \"\u8bf7\u8f93\u5165\u4f60\u7684\u9009\u62e9\uff08\u6216\u8f93\u5165'q'\u9000\u51fa\uff09: \",\n                timeout=60\n            )\n            if input_str.lower() == 'q':\n                return 0\n            return InputValidator.validate_choice(input_str, options)\n        except ValueError as e:\n            print(colored(str(e), 'red'))\n            return -1\n\n# \u589e\u5f3a\u6587\u4ef6\u4fdd\u5b58\nclass SafeSaver:\n    LOCK_TIMEOUT = 5\n    \n    @classmethod\n    def save(cls, filename: str, data: dict):\n        lock_path = Path(filename + \".lock\")\n        try:\n            with FileLock(lock_path, timeout=cls.LOCK_TIMEOUT):\n                with open(filename, 'w', encoding='utf-8') as f:\n                    json.dump(data, f, ensure_ascii=False)\n        except Timeout:\n            raise StoryGenerationError(\"\u6587\u4ef6\u88ab\u9501\u5b9a\uff0c\u4fdd\u5b58\u5931\u8d25\")\n\n# \u5728StoryManager\u4e2d\u66ff\u6362\u4fdd\u5b58\u65b9\u6cd5\ndef save_progress(self, filename: str = \"autosave.json\") -> None:\n    save_data = {\n        \"chapter\": self.current_chapter,\n        \"history\": self.story_history,\n        \"decisions\": self.decision_points,\n        \"achievements\": [k for k, v in self.achievements.items() if v[1]]\n    }\n    SafeSaver.save(filename, save_data)\n    self.last_save_time = time.time()\n\n# \u521d\u59cb\u5316\u4e0e\u542f\u52a8\nif __name__ == \"__main__\":\n    try:\n        config = UserConfig()\n        engine = GameEngine(config)\n        engine.main_loop()\n    except ConfigError as e:\n        print(colored(f\"\u914d\u7f6e\u9519\u8bef: {e}\", 'red'))\n        sys.exit(1)\n    except StoryGenerationError as e:\n        print(colored(f\"\u6545\u4e8b\u751f\u6210\u9519\u8bef: {e}\", 'red'))\n        sys.exit(2)\n    except Exception as e:\n        print(colored(f\"\u672a\u9884\u671f\u7684\u9519\u8bef: {e}\", 'red'))\n        sys.exit(99)",
      "hash": "149abaa91cb2a246064f2e8284eb8fed"
    }
  },
  "history": [],
  "user_feedback": [
    "\u521b\u5efa\u4e00\u4e2a\u8c03\u7528openai\u63a5\u53e3\u7684\u7384\u5e7b\u5c0f\u8bf4\u5386\u9669\u8bb0\uff0c\u901a\u8fc7\u5bf9\u8bdd\u7684\u5f62\u5f0f\uff0c\u6765\u63a8\u52a8\u6545\u4e8b\u7684\u524d\u8fdb\uff0c\u6545\u4e8b\u8981\u6709\u723d\u70b9\u6709\u521b\u65b0",
    "\u57fa\u4e8e\u4ee5\u4e0b\u73b0\u6709\u4ee3\u7801\u8fdb\u884c\u6539\u8fdb\uff1a\n\n\"\"\"\nOpenAI\u7384\u5e7b\u5c0f\u8bf4\u5192\u9669\u751f\u6210\u5668\n\u4f9d\u8d56\uff1apip install openai python-dotenv\n\"\"\"\n\nimport os\nimport sys\nimport time\nfrom typing import List, Dict\nimport openai\nfrom dotenv import load_dotenv\n\n# \u52a0\u8f7d\u73af\u5883\u53d8\u91cf\nload_dotenv()\nopenai.api_key = os.getenv(\"OPENAI_API_KEY\")\n\nclass StoryManager:\n    \"\"\"\u7ba1\u7406\u6545\u4e8b\u751f\u6210\u72b6\u6001\u548c\u4e0a\u4e0b\u6587\"\"\"\n    \n    def __init__(self):\n        self.story_history: List[Dict] = []\n        self.current_chapter = 1\n        self.max_retries = 3\n        self.base_prompt = \"\"\"\n            \u4f60\u662f\u4e00\u4e2a\u7384\u5e7b\u5c0f\u8bf4\u5927\u5e08\uff0c\u8bf7\u751f\u6210\u5305\u542b\u4ee5\u4e0b\u8981\u7d20\u7684\u5192\u9669\u6545\u4e8b\uff1a\n            1. \u4e3b\u89d2\u62e5\u6709\u7279\u6b8a\u4f53\u8d28\u6216\u91d1\u624b\u6307\n            2. \u5305\u542b\u81f3\u5c11\u4e09\u4e2a\u521b\u65b0\u4fee\u70bc\u4f53\u7cfb\n            3. \u6bcf\u7ae0\u5fc5\u987b\u6709\u6218\u6597\u60c5\u8282\u548c\u5b9d\u7269\u83b7\u5f97\n            4. \u5305\u542b\u610f\u60f3\u4e0d\u5230\u7684\u5267\u60c5\u8f6c\u6298\n            5. \u5bf9\u573a\u666f\u548c\u529f\u6cd5\u8fdb\u884c\u8be6\u7ec6\u63cf\u5199\n            \u8bf7\u7528\u4e2d\u6587\u4ee5150\u5b57\u5de6\u53f3\u7684\u6bb5\u843d\u5448\u73b0\uff0c\u7ed3\u5c3e\u7ed9\u51fa2-3\u4e2a\u9009\u62e9\u5206\u652f\n        \"\"\"\n        \n    def generate_story_prompt(self, user_input: str = None) -> List[Dict]:\n        \"\"\"\u6784\u9020\u5e26\u4e0a\u4e0b\u6587\u7684\u63d0\u793a\u8bcd\"\"\"\n        system_msg = {\n            \"role\": \"system\",\n            \"content\": f\"{self.base_prompt} \u5f53\u524d\u662f\u7b2c{self.current_chapter}\u7ae0\uff0c\u4fdd\u6301\u6545\u4e8b\u8fde\u8d2f\u6027\u3002\"\n        }\n        \n        messages = [system_msg]\n        \n        # \u6dfb\u52a0\u4e0a\u4e0b\u6587\u5386\u53f2\n        if self.story_history:\n            messages += self.story_history[-4:]  # \u4fdd\u6301\u6700\u8fd13\u8f6e\u5bf9\u8bdd\n        \n        # \u6dfb\u52a0\u7528\u6237\u8f93\u5165\n        if user_input:\n            messages.append({\"role\": \"user\", \"content\": user_input})\n        else:\n            messages.append({\"role\": \"user\", \"content\": \"\u8bf7\u5f00\u59cb\u65b0\u7684\u6545\u4e8b\"})\n            \n        return messages\n\nclass OpenAIClient:\n    \"\"\"\u5904\u7406OpenAI API\u4ea4\u4e92\"\"\"\n    \n    def __init__(self):\n        self.model = \"gpt-3.5-turbo\"\n        self.temperature = 0.8\n        self.max_tokens = 1500\n        \n    def generate_story(self, messages: List[Dict]) -> str:\n        \"\"\"\u8c03\u7528OpenAI\u751f\u6210\u6545\u4e8b\u5185\u5bb9\"\"\"\n        for _ in range(3):  # \u91cd\u8bd5\u673a\u5236\n            try:\n                response = openai.ChatCompletion.create(\n                    model=self.model,\n                    messages=messages,\n                    temperature=self.temperature,\n                    max_tokens=self.max_tokens\n                )\n                return response.choices[0].message['content'].strip()\n            except Exception as e:\n                print(f\"API\u9519\u8bef: {e}, \u91cd\u8bd5\u4e2d...\")\n                time.sleep(2)\n        return \"\u6545\u4e8b\u751f\u6210\u5931\u8d25\uff0c\u8bf7\u7a0d\u540e\u518d\u8bd5\"\n\ndef display_story(content: str):\n    \"\"\"\u7f8e\u5316\u6545\u4e8b\u663e\u793a\"\"\"\n    print(\"\\n\" + \"=\"*50)\n    print(f\"\ud83d\udcd6 \u7b2c{story_mgr.current_chapter}\u7ae0 \ud83d\udcd6\")\n    print(\"-\"*50)\n    print(content.replace(\". \", \".\\n\"))\n    print(\"=\"*50 + \"\\n\")\n\ndef main():\n    \"\"\"\u4e3b\u7a0b\u5e8f\u5165\u53e3\"\"\"\n    story_mgr = StoryManager()\n    ai_client = OpenAIClient()\n    \n    print(\"\u6b22\u8fce\u6765\u5230\u7384\u5e7b\u5c0f\u8bf4\u5192\u9669\u751f\u6210\u5668\uff01\")\n    print(\"\u8f93\u5165\u4f60\u7684\u9009\u62e9\uff08\u6570\u5b57\uff09\u6216\u81ea\u7531\u8f93\u5165\uff0c\u8f93\u5165q\u9000\u51fa\\n\")\n    \n    user_input = None\n    while True:\n        # \u751f\u6210\u6545\u4e8b\u5185\u5bb9\n        messages = story_mgr.generate_story_prompt(user_input)\n        story_content = ai_client.generate_story(messages)\n        \n        # \u5904\u7406\u751f\u6210\u5931\u8d25\u7684\u60c5\u51b5\n        if \"\u5931\u8d25\" in story_content:\n            print(story_content)\n            break\n            \n        display_story(story_content)\n        \n        # \u8bb0\u5f55\u5386\u53f2\n        story_mgr.story_history.extend([\n            {\"role\": \"assistant\", \"content\": story_content},\n            {\"role\": \"user\", \"content\": user_input} if user_input else None\n        ])\n        \n        # \u83b7\u53d6\u7528\u6237\u8f93\u5165\n        choice = input(\"\u8bf7\u8f93\u5165\u4f60\u7684\u9009\u62e9\uff08\u8f93\u5165\u6570\u5b57\u6216\u81ea\u5b9a\u4e49\u5185\u5bb9\uff09\uff1a\").strip()\n        if choice.lower() == 'q':\n            print(\"\\n\u5192\u9669\u7ed3\u675f\uff0c\u671f\u5f85\u4e0b\u6b21\u518d\u89c1\uff01\")\n            break\n            \n        user_input = f\"\u7528\u6237\u9009\u62e9\uff1a{choice}\u3002\u8bf7\u6839\u636e\u8fd9\u4e2a\u9009\u62e9\u7ee7\u7eed\u53d1\u5c55\u6545\u4e8b\uff0c\u4fdd\u6301\u8282\u594f\u7d27\u51d1\uff0c\u5e76\u6dfb\u52a0\u65b0\u7684\u51b2\u7a81\u548c\u5947\u9047\u3002\"\n        story_mgr.current_chapter += 1\n        \nif __name__ == \"__main__\":\n    try:\n        main()\n    except KeyboardInterrupt:\n        print(\"\\n\u64cd\u4f5c\u5df2\u4e2d\u65ad\")\n        sys.exit(0)\n\n\u6539\u8fdb\u76ee\u6807\uff1a\u6269\u5c55\u73b0\u6709\u529f\u80fd\uff0c\u6dfb\u52a0\u65b0\u7279\u6027\n\n\u8bf7\u4fdd\u6301\u4ee3\u7801\u7684\u6838\u5fc3\u529f\u80fd\uff0c\u5728\u6b64\u57fa\u7840\u4e0a\u8fdb\u884c\u6539\u8fdb\u3002\n"
  ]
}